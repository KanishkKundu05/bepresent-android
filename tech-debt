# MVP Tech Debt Audit

## Last verified
- 2026-02-16 against `mvp` branch (HEAD: `ac93da9`).
- Items verified as fixed have been removed from this file.

## Severity key
- `S0`: Critical functional correctness or core-flow break.
- `S1`: High risk user-facing behavior gap.
- `S2`: Medium maintainability/performance/testability debt.
- `S3`: Low documentation/polish debt.

## Open debt

### Build & project

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-001 | S1 | Gradle wrapper is incomplete (`gradle-wrapper.jar` missing). | `gradle/wrapper/gradle-wrapper.properties`, missing `gradle/wrapper/gradle-wrapper.jar` | Clean checkout cannot rely on `./gradlew` unless global Gradle is installed. |
| TD-002 | S2 | No test baseline exists (unit/instrumentation test sources absent). | No files under `app/src/test` or `app/src/androidTest` | Regressions can ship without automated safety net. |

### Manifest & resources

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-003 | S2 | App backup is enabled despite storing behavior-sensitive local data. | `app/src/main/AndroidManifest.xml:36` | Device/app backup can copy usage/intentions/session data unexpectedly. |
| TD-004 | S2 | Shield activity uses the base app theme, not a dedicated fullscreen shield theme. | `app/src/main/AndroidManifest.xml:60`, `app/src/main/res/values/themes.xml:3` | Shield-specific visual/system-bar behavior is harder to control and isolate. |
| TD-005 | S3 | Most UI copy remains hardcoded in composables instead of resource-backed strings. | Example: `ScreenTimeCard.kt:59` | Localization/theming consistency debt. |

### Data integrity (Room)

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-006 | S1 | `AppIntention` has no uniqueness guarantee on `packageName`; duplicates are structurally allowed. | `data/db/AppIntention.kt` | Duplicate intentions for same app can create inconsistent blocking/state math. |
| TD-007 | S1 | `getByPackage()` assumes uniqueness but query is unconstrained and unordered. | `data/db/AppIntentionDao.kt:18-19` | Returned intention is nondeterministic if duplicates exist. |
| TD-008 | S1 | Active session query is unordered (`LIMIT 1` without `ORDER BY`) while multiple active rows are possible. | `data/db/PresentSessionDao.kt:11-15` | Wrong active session can be selected for blocking, rewards, and shield type. |
| TD-009 | S2 | Session action rows have no Room FK/index constraints to `present_sessions`. | `data/db/PresentSession.kt:32-38` | Orphaned or slow action queries become likely as data grows. |

### Usage stats

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-010 | S2 | Usage stats methods are synchronous and called from non-IO paths in UI flow. | `data/usage/UsageStatsRepository.kt:23-46` | Main-thread stalls/jank risk on slower devices or large usage datasets. |
| TD-011 | S2 | Foreground detection relies only on recent `MOVE_TO_FOREGROUND` events in last 5s. | `data/usage/UsageStatsRepository.kt:41-55` | Detection can be stale/null outside event windows, reducing shielding reliability. |

### Navigation & DI

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-012 | S2 | Onboarding/dashboard routing is state-only with no explicit nav contract; callback is a no-op. | `MainActivity.kt:35-39` | Flow control is implicit and fragile under future onboarding changes. |
| TD-013 | S2 | Onboarding composition uses `EntryPointAccessors` directly in UI layer instead of typed ViewModel/injected boundaries. | `ui/onboarding/OnboardingScreen.kt:58-66` | Harder to test, mock, and evolve onboarding state machine. |
| TD-014 | S2 | Permission status model marks notifications+battery in `allGranted`, but dashboard only checks usage stats via `criticalGranted`; policy is inconsistent across layers. | `permissions/PermissionManager.kt:58-64` | Permission UX semantics drift and confuse operational behavior. |

### Hardcoded strings

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-015 | S3 | Onboarding strings are hardcoded despite `strings.xml` containing equivalents. | `ui/onboarding/OnboardingScreen.kt:94-183` | Localization/content iteration debt. |
| TD-043 | S3 | Service/shield notifications and copy are hardcoded in codepaths rather than resources. | `service/MonitoringService.kt`, `IntentionAlarmReceiver.kt`, `SessionAlarmReceiver.kt` | Localization/content governance debt. |

### App picker

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-016 | S2 | Installed app discovery runs on main thread in `LaunchedEffect`. | `ui/picker/AppPickerSheet.kt:62-78` | Opening picker can cause visible UI hitching. |
| TD-017 | S2 | Per-row icon conversion (`Drawable`â†’`Bitmap`) is performed in composition path for each item. | `ui/picker/AppPickerSheet.kt:147-151` | Memory churn and scroll jank risk on large app lists. |
| TD-018 | S3 | Selection state is ephemeral and not modeled for preselection/edit workflows. | `ui/picker/AppPickerSheet.kt:60` | Re-open/edit UX will require ad-hoc state plumbing later. |

### Intentions

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-021 | S1 | `openApp()` performs multi-step state mutation without transaction boundary. | `features/intentions/IntentionManager.kt:65-69` | Partial writes can desync opens count vs open-state on failures. |
| TD-022 | S1 | Spec says open-window should emit immediate notification; manager does not do this. | `features/intentions/IntentionManager.kt:65-69`, spec `planning/mvp-single-screen.md:171-176` | User gets weaker time-window awareness and less predictability. |
| TD-023 | S2 | Alarm scheduling uses `setAlarmClock()` for internal timers (shows system alarm icon). | `features/intentions/IntentionManager.kt:97-116` | System alarm UX semantics/noise for non-user alarms. |

### Sessions

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-027 | S1 | `createAndStart()` bypasses state machine validation and can create a new active session without checking existing one. | `features/sessions/SessionManager.kt:30-67` | Multiple active sessions and nondeterministic blocking become possible. |
| TD-028 | S1 | Session start lacks manager-level validation for empty blocked app set / blank session naming constraints. | `features/sessions/SessionManager.kt:30-47` | Invalid session records can enter DB when called outside current UI assumptions. |
| TD-030 | S2 | Session goal timer uses `setAlarmClock()` for internal alarm. | `features/sessions/SessionManager.kt:180-183` | Same platform-fit/UX debt as intention timers (TD-023). |

### Service & receivers

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-033 | S1 | Service start path does not verify Usage Access permission as required by spec. | `service/MonitoringService.kt:42-46` | Silent monitoring failures instead of guided recovery. |
| TD-034 | S1 | Session notification update API exists but is never integrated into session lifecycle. | `service/MonitoringService.kt:135-172` | Chronometer/goal update behavior is incomplete in runtime flow. |
| TD-036 | S2 | Broadcast receivers instantiate ad-hoc Room DB instances per event instead of injected singleton. | `service/BootCompletedReceiver.kt:19-23`, `IntentionAlarmReceiver.kt:21-25`, `SessionAlarmReceiver.kt:26-30` | Repeated cold DB setup overhead and duplicated persistence config. |
| TD-037 | S1 | Boot receiver does not gate service start on current permission health. | `service/BootCompletedReceiver.kt:29-31` | Service can restart into non-functional state after reboot. |

### Shield / blocking

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-038 | S1 | `BlockedAppActivity` is `singleTask` but has no `onNewIntent` handling for updated extras. | `features/blocking/BlockedAppActivity.kt` | Existing activity instance can show stale shield context. |
| TD-039 | S1 | Intention shield exits composition when intention lookup fails, leaving blank content. | `features/blocking/ShieldScreen.kt:225` | User can hit empty/blocked UI state without recovery action. |
| TD-040 | S2 | Session and goal-reached shield variants read session once (non-reactive snapshot). | `features/blocking/ShieldScreen.kt:76-80`, `151-155` | UI can drift from actual session state while shield is visible. |
| TD-041 | S2 | Session shield includes stubbed secondary action (`Unlock?` no behavior). | `features/blocking/ShieldScreen.kt:129` | Incomplete interaction contract in a core intervention screen. |
| TD-042 | S1 | Freeze banner is tied directly to global availability flag, not "freeze active for this day". | `features/blocking/ShieldScreen.kt:219`, `290-298` | Misleading streak messaging and user trust issues. |

### Dashboard

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-044 | S1 | Permission banner claims "tap to fix" but has no clickable behavior or settings routing. | `ui/dashboard/DashboardScreen.kt:101-116` | Broken expectation in critical recovery flow. |
| TD-045 | S1 | Active session elapsed/cancel window use one-shot wall clock reads without ticker state. | `ui/dashboard/DashboardScreen.kt:261-263` | Timer/cancel affordances become stale until unrelated recomposition. |
| TD-046 | S3 | Dead UI state remains (`appPickerMode`, unused `context`). | `ui/dashboard/DashboardScreen.kt:48`, `52` | Cognitive load and risk during future edits. |
| TD-047 | S2 | ViewModel combine uses indexed casts from vararg array instead of typed combine. | `ui/dashboard/DashboardViewModel.kt:47-63` | Refactor brittleness and runtime cast-risk debt. |
| TD-048 | S2 | Permission health in dashboard only respects `criticalGranted` (usage stats), diverging from broader checks in docs. | `ui/dashboard/DashboardViewModel.kt:72` | Dashboard may under-report degraded reliability states. |
| TD-049 | S2 | Screen time and intention cards convert app icons to bitmaps inside composition paths. | `ui/components/ScreenTimeCard.kt:97-103`, `ui/components/IntentionCard.kt:36-39` | Recomposition/scroll performance and memory churn debt. |

### Documentation drift

| ID | Sev | Debt | Evidence | Impact |
|---|---|---|---|---|
| TD-052 | S1 | Docs call out permission banner tap-to-fix behavior; dashboard implementation lacks this action. | `docs/features.md:98`, `ui/dashboard/DashboardScreen.kt:101-116` | Recovery path documented but not implemented. |
| TD-053 | S1 | Docs describe session notification action and full chronometer lifecycle; implementation is partial/unwired. | `planning/mvp-single-screen.md:960-963`, `service/MonitoringService.kt:135-172` | Feature completeness appears higher in docs than in shipped code. |

## Cross-cutting debt inventory

| Area | Debt summary | Open items |
|---|---|---|
| Data integrity | No uniqueness/FK constraints for key entities and nondeterministic active-session queries. | TD-006, TD-007, TD-008, TD-009 |
| Dashboard recovery UX | Critical permission banner promises an action it does not provide. | TD-044, TD-052 |
| Session validation | No guard against duplicate active sessions or invalid session params. | TD-027, TD-028 |
| Alarm API misuse | `setAlarmClock()` used for internal timers across intentions and sessions. | TD-023, TD-030 |
| Performance | App enumeration/icon conversion on main thread, ad-hoc DB builders in receivers. | TD-010, TD-016, TD-017, TD-036, TD-049 |
| Shield UX gaps | Blank state on lookup failure, stale session reads, stubbed actions, misleading freeze banner. | TD-038, TD-039, TD-040, TD-041, TD-042 |
| Testability | No automated tests in repo. | TD-002 |
| Documentation drift | Docs claim behavior that current code does not fully implement. | TD-052, TD-053 |
| Hardcoded strings | UI, notifications, and onboarding copy not resource-backed. | TD-005, TD-015, TD-043 |

## Resolved debt (removed from this audit)

| ID | Resolution |
|---|---|
| TD-019 | Service files now exist; imports compile. |
| TD-020 | `checkAndStop()` now conditionally checks active session + intention count before stopping. |
| TD-024 | Freeze logic now protects all over-limit intentions uniformly. |
| TD-025 | Monday auto-grant now runs before any freeze consumption in `doWork()`. |
| TD-026 | Same as TD-019; session manager imports now resolve. |
| TD-029 | Session end transitions now use conditional `checkAndStop()`. |
| TD-031 | `startPolling()` guards against duplicate loops (`if (pollingJob?.isActive == true) return`). |
| TD-032 | `checkAndStop()` is now conditional (checks session + intention count). |
| TD-035 | Re-block receiver now checks foreground app and relaunches shield if still in foreground. |
| TD-050 | Docs accurately describe conditional stop behavior (matches TD-032 fix). |
| TD-051 | Docs accurately describe conditional re-shield behavior (matches TD-035 fix). |
